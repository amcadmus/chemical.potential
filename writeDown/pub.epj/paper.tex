%%%%%%%%%%%%%%%%%%%%%%% file template.tex %%%%%%%%%%%%%%%%%%%%%%%%%
%
% This is a template file for The European Physical Journal Special Topics
%
% Copy it to a new file with a new name and use it as the basis
% for your article
%
%%%%%%%%%%%%%%%%%%%%%%%% Springer-Verlag %%%%%%%%%%%%%%%%%%%%%%%%%%
%
\documentclass[epjST]{svjour}
%
\usepackage{graphics}
\usepackage{color, colortbl}
\usepackage{amsmath,amssymb}
\usepackage{graphicx}
\usepackage{tabularx}

\newcommand{\recheck}[1]{{\color{red} #1}}
\newcommand{\redc}[1]{{\color{red} #1}}
\newcommand{\bluec}[1]{{\color{red} #1}}
\newcommand{\greenc}[1]{{\color{green} #1}}
\newcommand{\vect}[1]{\textbf{\textit{#1}}}
\newcommand{\dd}[1]{\textsf{#1}}
\newcommand{\fwd}[0]{\textrm{fw}}
\newcommand{\bwd}[0]{\textrm{bw}}
\newcommand{\period}[0]{T_{\textrm{P}}}
\newcommand{\ml}[0]{\mathcal {L}}
\newcommand{\mo}[0]{\mathcal {O}}
\newcommand{\mbp}[0]{\mathbb {P}}
\newcommand{\mh}[0]{\mathcal {H}}
\newcommand{\dist}[0]{\textrm {dist}}
\newcommand{\AT}[0]{\textrm{AT}}
\newcommand{\HY}[0]{\textrm{HY}}
\newcommand{\CG}[0]{\textrm{CG}}
\newcommand{\EX}[0]{\textrm{EX}}
\newcommand{\moleidxone}[0]{i}
\newcommand{\moleidxtwo}[0]{j}
\newcommand{\atomidxone}[0]{\alpha}
\newcommand{\atomidxtwo}[0]{\beta}
\newcommand{\thf}{{\textrm{th}}}
\newcommand{\rdf}{{\textrm{rdf}}}
\newcommand{\rep}{{\textrm{rep}}}
\newcommand{\dof}{{\textrm{DOF}}}
\newcommand{\exc}{{\textrm{extra}}}
\newcommand{\equi}{{\textrm{eq}}}

% \usepackage{amsfonts}
% \newcommand{\tickYes}{\checkmark}
% \usepackage{pifont}
% \newcommand{\tickNo}{\hspace{1pt}\ding{55}}
% \definecolor{MyGray}{gray}{0.85}

%
\begin{document}
%
\title{Adaptive Resolution Simulation: Theoretical Fundations and Open Questions}
\author{Han Wang\inst{1}\fnmsep\thanks{\email{han.wang@fu-berlin.de}}}
%
\institute{Zuse Institut Berlin}
%
\abstract{
Insert your abstract here.
} %end of abstract
%
\maketitle
%


\section{The two ways  of designing the hybrid region}

The AdResS uses a weighting function $w(\vect r)$ that is a scalor
function defined over the simulation region to denote the resolution
of the system. In the atomistic region the value of the
weighting function is usually set to 1, while in the coarse-grained
region it is usually set to 0. In between, there is a bybrid region
that is denoted by $\Omega_\HY$
(or called transition region), where the molecules
has both the atomistic and coarse-grained resolutions, and the weighting function
goes smoothly from 1 to 0. The way of designing the weighting function
is not unique, one possible and perhaps the most popular choice is
\begin{equation}\label{eqn:old-w}
  w(\vect r) =
  \left\{
    \begin{alignedat}{3}
      &1 &\quad& \vect r \in \Omega_\AT\\
      &\cos^2\Big[\frac{\pi}{2 } \cdot \frac{\dist(\vect r, \Omega_\AT)}{d_\HY}\,\Big] && \vect r \in\Omega_\HY \\
      &0 &    & \vect r \in \Omega_\CG 
    \end{alignedat}
  \right.
\end{equation}
where $\dist(\vect r, \Omega_\AT)$ is the distance between the
position $\vect r$ and the atomistic region, which is defined
by $\dist(\vect r, \Omega_\AT) = \min_{\vect s\in\Omega_\AT} \vert
\vect r - \vect s \vert$.  $d_\HY$ is the thickness of the hybrid
region. We always assume the thickness of the hybrid region is
uniform, which indicates that the weighting function smoothly vanishes
at the boundary between the hybrid and the coarse-grained regions.
Since all interactions (including the electrostatic interction) are treated
by cut-off method, the weighting function requires the thickness of
the hybrid region being at least one cut-off radius (denoted by $r_c$). 
The benefite of this setting is that the atomistic
region is not directly interacting with the coarse-grained region,
so there is no extra work for modeling the interactions between the atomistic
and coarse-grained resolutions.

Both the atomistic and coarse-grained intermolecular interactions are
well defined in the atomistic region and coarse-grained regions,
respectively.  To setup an AdResS simulation, one needs to define the
interactions in the hybrid region. There are in general two
possibilities: force interpolation and the potential interpolation.
The force interpolation approach defines the hybrid force between two
molecules (saying $\moleidxone$ and $\moleidxtwo$) by a linear interpolation
between the atomistic (denoted by ${\vect F}_{\moleidxone\moleidxtwo}^{\AT}$) and coarse-grained (denoted by ${\vect F}_{\moleidxone\moleidxtwo}^{\CG}$) forces.
\begin{align}\label{eqn:f-f-interpol}
  {\vect F}_{\moleidxone \moleidxtwo}=w_\moleidxone w_\moleidxtwo{\vect F}_{\moleidxone\moleidxtwo}^{\AT}+(1-w_\moleidxone w_\moleidxtwo){\vect F}^{\CG}_{\moleidxone\moleidxtwo} 
\end{align}
where $w_\moleidxone = w(\vect r_\moleidxone)$ is the weighting function
measured at the center-of-mass (COM) position of molecule $\moleidxone$.
It should be noted that the AdResS  force interpolation is not conservative, i.e.~there does not
exist a potential so that the force interpolation is derived by taking the negative gradient of the potential,
unless the coarse-grained interaction is identical to the atomistic interaction~\cite{praprotnik2011comment,dellesite2007some}.
It is easy to show that the force interpolation satisfies the momentum conservation: Since
both the atomistic and coarse-grained forces are subject to the Newton's third law, i.e.~${\vect F}_{\moleidxone\moleidxtwo}^{\AT} = - {\vect F}_{\moleidxtwo\moleidxone}^{\AT}$
and ${\vect F}_{\moleidxone\moleidxtwo}^{\CG} = - {\vect F}_{\moleidxtwo\moleidxone}^{\CG}$, from the definition Eq.~\eqref{eqn:f-f-interpol} we have ${\vect F}_{\moleidxone\moleidxtwo} = - {\vect F}_{\moleidxtwo\moleidxone}$.

The potential interpolation approach defines the hybrid energy by the same idea:
\begin{align}\label{eqn:v-v-interpol}
  {V}_{\moleidxone \moleidxtwo}=w_\moleidxone w_\moleidxtwo{V}_{\moleidxone\moleidxtwo}^{\AT}+(1-w_\moleidxone w_\moleidxtwo){V}^{\CG}_{\moleidxone\moleidxtwo} 
\end{align}
The intermolecular force is therefore calculated by taking the negative gradient on the potential ${\vect F}^V_{\moleidxone \moleidxtwo}= -\nabla_{\moleidxone}{V}_{\moleidxone \moleidxtwo}$,
which is explicitly written as
\begin{align}\label{eqn:f-v-interpol}
  {\vect F}^V_{\moleidxone \moleidxtwo}
  &=w_\moleidxone w_\moleidxtwo{\vect F}_{\moleidxone\moleidxtwo}^{\AT}+(1-w_\moleidxone w_\moleidxtwo){\vect F}^{\CG}_{\moleidxone\moleidxtwo}  - \nabla w_\moleidxone\cdot w_\moleidxtwo (V^\AT_{\moleidxone \moleidxtwo} - V^\CG_{\moleidxone \moleidxtwo})
\end{align}
Where $\nabla w_\moleidxone$ is the gradient of the weighting function measured at position $\vect r_\moleidxone$,
and the superscipt ``$V$'' denotes that the force is defined
by the potential interpolation.
By  definition~\eqref{eqn:f-v-interpol}, the force of potential interpolation is conservative. 
The difference between the force and potential
interpolations lies in the last term  of Eq.~\eqref{eqn:f-v-interpol}, which is a force
acting along the direction of decreasing weighting function.
This force is defined as the force of changing representation:
It should be noted that
the last term breaks the Newton's third law, therefore the force of potential interpolation
does not conserves the momentum.
We define the accumulative effect of this term by the force of changing representation:
\begin{align}
  \vect F_\moleidxone^\rep = \sum_{\moleidxtwo}  \nabla w_\moleidxone\cdot w_\moleidxtwo (V^\AT_{\moleidxone \moleidxtwo} - V^\CG_{\moleidxone \moleidxtwo})
\end{align}

\begin{table}
  \centering
  \caption{A summary of the fundamental conservation laws in mechanics 
    satisfied by the normal molecular system and AdResS systems defined by force and potential interpolations.}
  \label{tab:conv-laws}
  \begin{tabular*}{0.8\textwidth}{@{\extracolsep{\fill}}lcc}\hline\hline
    &         Momentum Consv.     &       Energy Consv. \\
    Normal molecular System     &       {Yes}        &       {Yes}\\      
    AdResS force interpol.   &       {Yes}        &       {No}\\      
    AdResS potential interpol.  &     {No}  &       {Yes}\\\hline\hline
  \end{tabular*}
\end{table}
The fundamental conservation laws satisfied by both the force and potential interpolations
are summarized in Tab.~\ref{tab:conv-laws}. Unlike normal molecular systems, in which both
the momentum and energy are conserved, neither of the AdResS systems conserves
both laws. The breaks of these mechanics conservations have substantial influence on the thermodynamic
properties of the AdResS systems (see the discussions in Sec.~\ref{sec:thermodynamic}). The choice of the interpolation scheme depends on
the practical requirement, for example, in some systems it is crucial to have the momentum
conservation, then the force interpolation is prefered, and vice versa.
In equilibrium case, we will show later in Sec.~\ref{sec:statistical}
that both approaches approximately sample the grand-canonial ensamble.

When the intermolecular force is defined by either
Eq.~\eqref{eqn:f-f-interpol} or \eqref{eqn:f-v-interpol}, the total
force exserts on one molecule is given by the normal adding up rule:
\begin{align}
  \vect F_\moleidxone = \sum_\moleidxtwo \vect F_{\moleidxone\moleidxtwo}, \quad \vect F^V_\moleidxone = \sum_\moleidxtwo \vect F^V_{\moleidxone\moleidxtwo}
\end{align}
On the force on the atomistic DOFs of a hybrid molecules is distributed 
by, taking atom $\atomidxone$ on molecule $\moleidxone$ for example,
\begin{align}
  \vect F_\atomidxone = \frac{m_\atomidxone}{M_\moleidxone}\vect F_\moleidxone, \quad   \vect F^V_\atomidxone = \frac{m_\atomidxone}{M_\moleidxone}\vect F^V_\moleidxone 
\end{align}
where $m_\atomidxone$ is the mass of atom, and $M_\moleidxone$ is the total mass of molecule $\moleidxone$, i.e.~$M_\moleidxone = \sum_{\atomidxone\in\moleidxone}m_\atomidxone$.

Before discussing the statistical and thermodynamic properties of AdResS, a few comments on the
choice of the weighting function should be added. 
In Ref.~\cite{wang2012adaptive} the authors introduced a modified weighing function that
introduce a buffer region so that the molecules with the atomistic resolution
interacts with the hybrid region via the atomistic intermolecular interaction:
\begin{equation}\label{eqn:new-w}
  w(\vect r) =
  \left\{
    \begin{alignedat}{3}
      &1 &\quad& \vect r \in \Omega_\AT\\
      &1 && \vect r \in\Omega_\HY, \dist(\vect r, \Omega_\AT) < r_c \\
      &\cos^2\Big[\frac{\pi}{2 } \cdot \frac{\dist(\vect r, \Omega_\AT) - r_c}{d_{{\HY}} - r_c}\,\Big] && \vect r \in\Omega_\HY, \dist(\vect r, \Omega_\AT) \geq r_c\\
      &0 &    & \vect r \in \Omega_\CG 
    \end{alignedat}
  \right.
\end{equation}
The minimum thickness of the hybrid region is therefore $2r_c$.
It worth noting that the coarse-grained region does not requires a buffer in the hybrid region, because
by definition the coarse-grained region interacts with the hybrid region via the coarse-grained intermolecular interaction.
The new definition~\eqref{eqn:new-w} is crucial for the equilibrium statistical properties of the AdResS,
however, the extra cost of is spent in the buffer $\{\vect r \vert \vect r \in\Omega_\HY, \dist(\vect r, \Omega_\AT) < r_c\}$,
which is treated in atomistic resolution. This cost is relatively small for systems with large atomistic region.

\recheck{Remark, add the remark of inversed weighting function}

\section{Equilibrium statistical properties of adaptive resolution simulation}
\label{sec:statistical}

To consider the accuracy of the AdResS simulation, we always compare it with a
atomistic reference system, which is of the same size as the AdResS system, and contains the same number of molecules.
If the statistal properties of the atomistic region in the AdResS simulation
is same as the corresponding subregion in the atomistic reference, then
the atomistic region is embeded into the AdResS system as if it were embeded in to
an atomistic environment, and the AdResS simulation is of good accuracy.
\recheck{comments on the ``atomistic region'' of the reference system}

We denote the number of molecules, volume and temperture of the system by $N$, $V$ and $T$, respectively.
The atomistic reference system has exactly the same set of variables, and its equilibrium state  is
the desired equilibrium.
% The word ``desired'' means that
% the atomistic region of the AdResS system should reproduce the equilibrium properties corresponding subregion of the reference
% system.
The thermodynamic variables for subregions are specified by the subscript,
for example, the those of the atomistic region are 
$N_\AT$, $V_\AT$ and $T_\AT$. Those of the hybrid and coarse-grained regions
are denoted by adding ``$\HY$'' and ``$\CG$'', respectively.
Identities $N = N_\AT + N_\HY + N_\CG$ and $V = V_\AT + V_\HY + V_\CG$ obviously hold
in the AdResS system.
In equilibrium, the temperature is uniform across the system: $T = T_\AT = T_\HY = T_\CG$.
This is achieved in practice by coupling the whole system to a Langevin thermostat.
The pressure and chemical potential of the atomistic and coarse-grained regions
are denoted by $\{p_\AT, \mu_\AT\}$
and $\{p_\CG, \mu_\CG\}$, respectively.
The DOFs of molecules indexed $\moleidxone$ are $\vect x_\moleidxone = \{\vect r_\moleidxone, \vect p_\moleidxone\}$, where
$\vect r_\moleidxone$ denotes the generalized coordinates and $\vect p_\moleidxone$ denotes the corresponding momenta.
All DOFs of the system is denoted by $\vect x = \{\vect x_1, \cdots, \vect x_N\}$. Without lost of
generality, the first molecules index by $\{1, \cdots, N_\AT\}$ are in the atomistic region, then $\{N_\AT+1, \cdots, N_\AT + N_\HY\}$ in hybrid region, and
the last $N_\CG$ molecules $\{N-N_\CG+1, \cdots, N\}$ are in the coarse-grained region. The corresponding DOFs are denoted by $\vect x_\AT$, $\vect x_\HY$ and $\vect x_\CG$.
\redc{The atomistic, hybrid and coarse-grained have different DOFs, a comment needed!}

\begin{figure}
  \centering
  \includegraphics[width=0.3\textwidth]{figs/system.thermo/system.eps}
  \caption{A schematic plot of the AdResS system in thermodynamic
    equilibrium. The number of molecules, volume and temperature of
    the atomistic and coarse-grained regions are denoted by $\{N_\AT,
    V_\AT, T\}$ and $\{N_\AT, V_\AT, T\}$, respectively. The filter
    allows free exchange of molecules between atomistic and
    coarse-grained regions.}
  \label{fig:system-thermo}
\end{figure}

We consider the system in the thermodynamic limit: both the atomistic
and the coarse-grained regions are infinitely large, and at the same
time, the atomistic region is much larger than the coarse-grained
region. The hybrid region is much smaller than both the atomistic and
coarse-grained regions.  Therefore, the number of molecules in the
three regions satisfies $N_\CG\gg N_\AT\gg N_\HY$.  The coarse-grained
region can be treated as an infinitely large particle and energy
reservior of the atomistic region, and the hybrid region is an
infinitely thin filter that changes molecular resolution when a
molecule passes by (see Fig.~\ref{fig:system-thermo}). In the
thermodynamic limit, if there were no change of resolution (or
considering the full atomistic reference system), it is obvious that
the subregion corresponds to the atomistic region samples the
grand-canonial ensemble.  The question regarding the accuracy of
AdResS can be asked by: How accurately the atomistic region samples
the grand-canonial ensemble in the thermodynamic limit. Being more
specifically, we want to prove the probability density of the atomistic region satisfies
\begin{align}\label{eqn:dist-0}
  p(\vect x_\AT, N_\AT) \approx \frac{1}{\mathcal Z} \exp\Big\{{\beta\mu^\ast_\AT N_\AT - \beta \mh^\AT(\vect x_\AT)} \Big\}
\end{align}
where $\mu^\ast_\AT$ is the chemical potential of reference system in
desired equilibrium, $\mathcal Z$ is the partition function
normalizing the probability density, and $\mh^\AT$ is the atomistic
Hamiltonian defined in the the subregion of the reference system that
corresponds to the atomistic region of the AdResS system.

In stead of directly proving Eq.~\eqref{eqn:dist-0}, Ref.~\cite{wang2013grand}
suggest investigating the following equivalent equations:
\begin{align}\label{eqn:dist-1-0}
  p(\vect x_\AT \vert N_\AT) &\approx \frac{1}{Z_{N_\AT}} \exp\Big\{{- \beta \mh^\AT(\vect x_\AT)}\Big\}  \\\label{eqn:dist-1-1}
  p(N_\AT) & \approx \frac{ Z_{N_\AT}}{\mathcal Z} \exp\Big\{{\beta\mu^\ast_\AT N_\AT}\Big\}
\end{align}
where $Z_{N_\AT}$ is the canonical partition function for an atomistic
system with $N_\AT$ molecules
\begin{align}
  Z_{N_\AT} = \int d\vect x_{\AT} \exp\Big\{{- \beta \mh^\AT(\vect x_\AT)}\Big\}.
\end{align}
The identity of the conditional probability holds: $ p(\vect x_\AT, N_\AT)  = p(\vect x_\AT \vert N_\AT) \, p(N_\AT) $.

\subsection{The accuracy of the configurational probability density}
The configurational probability density~\eqref{eqn:dist-1-0} is further splitted as
\begin{align}
  p(\vect x_\AT \vert N_\AT) =
  \sum_{N_\HY} \int {d}\vect x_\HY\,
  p(\vect x_\AT \vert N_\AT; \vect x_\HY, N_\HY)\cdot
  p(\vect x_\HY, N_\HY\vert N_\AT)  
\end{align}
The first probability density in the integral is the probability density
of atomistic DOFs conditioned on the number of atomistic molecules and all
hybrid DOFs.
It can shown that if
(1) all interactions in the system are cut-offed;
(2) The atomistic region interacts with the bybrid region only in an atomistic way;
(3) The system is short-range correlated, and the correlation between the atomistic
and the coarse-grained regions is negligible, then the probability density $p(\vect x_\AT \vert N_\AT; \vect x_\HY, N_\HY)$
is approximated by
\begin{align}\label{eqn:dist-conf-0}
  p(\vect x_\AT \vert N_\AT; \vect x_\HY, N_\HY)
  \propto
  \exp\Big\{-\beta \mh^\AT(\vect x_\AT; \vect x_\HY, N_\HY) \Big\},
\end{align}
where 
\begin{align}
  \mh^\AT(\vect x_\AT; \vect x_\HY, N_\HY)
  =
  \sum_{i=1}^{N_\AT}\frac12 m_i\vect v_i^2 +
  \sum_{i,j=1}^{N_\AT} \frac12 V^\AT(\vect r_{ij}) +
  \sum_{i=1}^{N_\AT}\sum_{j=N_\AT+1}^{N_\AT + N_\HY} V^\AT(\vect r_{ij})
\end{align}
is the atomistic Hamiltonian with parameters $\vect x_\HY, N_\HY$. It
should be noted that the probability density~\eqref{eqn:dist-conf-0}
is identical to that of the reference system with a subregion that
corresponds to the hybrid region.
The probability density and local Hamiltonian
can be written down for the coarse-grained region analogically.

In general, the probability density $p(\vect x_\HY, N_\HY\vert N_\AT)$
is not the same as the reference system.  For example, it has been
shown that the density distribution in the hybrid region deviates from
the desired one, even if the coarse-grained side is modelled to
reporduce the atomistic pressure~\cite{poblete2010coupling}.  However,
it is possible to raise necessary conditions that systematically
improves the accuracy of the probability density. The first necessary
condition is that the density profile of the hybrid region should be a
constant that is identical to the density of the atomistic reference
at desired equilibrium:
\begin{align}\label{eqn:necessary-1st}
  \rho_\HY(\vect r) = \rho_\AT^\ast = \frac NV
\end{align}
The second necessary condition is that the two body probability
density in the hybrid region is the same as the full atomistic
reference, In homogeneous and isotropic system, it is equivalent to
ask that the hybrid radial distribution function (RDF) should be the
same as that of the reference system:
\begin{align}\label{eqn:necessary-2nd}
  g_\HY(r) = g^\ast_\AT(r).
\end{align}
It is fully justified to systematically raise the necessary conditions
upto $m$-th multibody probability density, for example the third necessary condition would be
\begin{align}
  C^{(3)}_\HY = C^{(3)\ast}_\AT
\end{align}
where $C^{(3)}$ is the three-body correlation.
Since the system is homogeneous
and isotropic, the three-body probability density is equivalent to
three-body correlation function. 
% However, it is not convenient in
% numerics, because the correction to the $m$-th multibody probability density
% needs a $m$-body correction force in general, which is computationally
% too expensive.

In practice, the density in the hybrid region is correct by the
thermodynamic force~\cite{fritsch2012adaptive}, which is applied on top of the AdResS intermolecular interactions:
\begin{align}
  \vect F_\moleidxone &= \sum_\moleidxtwo \vect F_{\moleidxone\moleidxtwo}  + \vect F_\moleidxone^\thf,  \\
  \vect F^V_\moleidxone& = \sum_\moleidxtwo \vect F^V_{\moleidxone\moleidxtwo} + \vect F_\moleidxone^{\thf,V},
\end{align}
where the thermodynamic forces is a one-body force defined over space,
i.e.~$\vect F^\thf_i = \vect F^\thf(\vect r_\moleidxone)$ and $\vect F^{\thf, V}_\moleidxone = \vect F^{\thf,V}(\vect r_\moleidxone)$,
for force and potential interpolations, respectively.
The thermodynamic force is applied only in the hybrid region, and is
calculated by the following iterative scheme:
\begin{align}
  \vect F_{k+1}^{\thf(, V)} (\vect r) = \vect F_k^{\thf(, V)} (\vect r)-
  \frac{M}{\kappa(\rho^\ast_\AT)^2} \nabla\rho_k(\vect r)
\end{align}
where $k$ denotes the step of iteration. $\kappa$ is the
isothermo-compressibility. In equilibrium the density profile $\rho(\vect r)$ in the
atomistic and coarse-grained regions are constants, so the thermodynamic force
is updated only in the hybrid region. When the hybrid density is flat, the thermodynamic
force converges. An important subsequence of a flat hybrid density is that
\begin{align}
  \rho_\AT(\vect r) = \rho_\HY(\vect r) = \rho_\CG(\vect r) = \rho_\AT^\ast,
\end{align}
because the density profiles match at the atomistic-hybrid and
hybrid-coarse-grained boundaries.

In a numerical example of SPC/E water~\cite{berendsen1987missing}
system, it has been shown in Ref.~\cite{wang2013grand} that when the
thermodynamic force is applied, the AdResS atomistic region reporduces
mulit-body configurational probability density of the reference system
upto three-body correlation.
In principle, higher order of mulit-body correlation can be investigated in
a similar way. A surprising numerical observation is that although
only the thermodynamic force is applied, the second order necessary condition~\eqref{eqn:necessary-2nd}
is automatically fulfilled, because the RDF is identical to the reference system in the buffer hybrid region
$\{\vect r \,:\, \vect r \in\Omega_\HY, \dist(\vect r, \Omega_\AT) < r_c\}$ that is interacting with
the atomistic region. While the third necessary condition is not satisfied because deviation
in the three-body correlation presents in the buffer bybrid region.
It should be noted that there is no theoretical background why the second necessary
condition is satisfied by only using the thermodynamic force,
so one cannot expect the same benefit in other systems.

The second necessary condition~\eqref{eqn:necessary-2nd} is fulfilled by the
RDF correction $\vect F^\rdf$~\cite{wang2012adaptive}, which is a conservative two-body force added to the force interpolation~\eqref{eqn:f-f-interpol} as an extra term
that applies only in the hybrid region:
\begin{align}\label{eqn:rdf-corr-f}
  {\vect F}_{\moleidxone \moleidxtwo}
  =
  w_\moleidxone w_\moleidxtwo{\vect F}_{\moleidxone\moleidxtwo}^{\AT}
  +
  (1-w_\moleidxone w_\moleidxtwo){\vect F}^{\CG}_{\moleidxone\moleidxtwo}
  +
  w_\moleidxone w_\moleidxtwo(1-w_\moleidxone w_\moleidxtwo){\vect F}^{\rdf}_{\moleidxone\moleidxtwo}.
\end{align}
The RDF correction force is constructed from a RDF correction potential $V^\rdf$ by
\begin{align}
  \vect F_{\moleidxone\moleidxtwo}^\rdf = \vect F^\rdf(\vect r_{\moleidxone\moleidxtwo})
  = -\nabla_{\vect r} V^\rdf(r_{\moleidxone\moleidxtwo}),
\end{align}
which is calculated by the iterative Boltzmann inversion:
\begin{align}
  V_{k+1}^\rdf(r) = V_k^\rdf(r) + k_BT \ln \Big[\frac{g_k(r)}{g^\ast_\AT(r)}\Big] 
\end{align}
where $k$ is the step of iteration. When the RDF of $k$th iteration is
identical to that of the full atomistic reference $g^\ast_\AT(r)$, the
iteration converges. It has been shown that the iterative scheme of
thermodynamic force coupled with the iterative Boltzmann inversion RDF
is effective in correcting the density profile $g_\HY(\vect r)$ and
RDF $g_\HY(r)$ simultaneously~\cite{wang2012adaptive}.
For SPC/E water system when the RDF correction is applied, the third
necessary condition is automatically satisfied~\cite{wang2013grand}. Again, there is no
theoretical prove behind this phenomenum, and one cannot expect the same
benefit for other systems.

\noindent\textbf{Remark:} The RDF correction is developed only for the force interpolation scheme,
and a natural extension to the potential interpolation seems to be
\begin{align}
  {V}_{\moleidxone \moleidxtwo}
  =
  w_\moleidxone w_\moleidxtwo{V}_{\moleidxone\moleidxtwo}^{\AT}
  +
  (1-w_\moleidxone w_\moleidxtwo){V}^{\CG}_{\moleidxone\moleidxtwo}
  +
  w_\moleidxone w_\moleidxtwo(1-w_\moleidxone w_\moleidxtwo){V}^{\rdf}_{\moleidxone\moleidxtwo}.  
\end{align}
The effectiveness of this proposal has never been tested, and is still an open question.

\subsection{The accuracy of the number probability}

The accuracy of number probability $p(N_\AT)$ is investigated by a
Taylor expansion w.r.t.~the relative size of the atomistic region to
the whole system, which vanishes in the thermodynamic limit. The sufficient condition for the first order accuracy
asks for a balance of the chemical potential~\cite{wang2013grand}:
\begin{align}\label{eqn:mu-eq}
  \mu_\CG - \mu_\AT = \omega_0,
\end{align}
where $\omega_0$ corresponds to the work from the filter, on each
molecule that enters the atomistic region. An important conclusion
form Ref.~\cite{wang2013grand} is that the relation~\eqref{eqn:mu-eq}
holds when the thermodynamic force is applied so that the atomistic
and coarse-grained densities match. The conclusion is derived under
the assumption of thermodynamic limit and the decorrlation between the
atomistic and coarse-grained regions.

The second order accuracy is achieved if the isothermo-compressibilty of the atomistic and coarse-grained sizes matches:
\begin{align}
  \kappa_\AT = \kappa_\CG
\end{align}
This is achieved by coarse-grained modeling, for example, the
structure based coarse-grained models that reproduces the atomistic
RDF~\cite{wang2009comparative}.

\subsection{The WCA potential as a generic energy and particle reservior}

From the accuracy analysis one surprising fact is that if the
requirement for the accuracy is not very high, and only applying the
thermodynamic force is acceptable, then there is actually no
restriction on the coarse-grained model. One can even use ideal gas as
a coarse-grained model, but the computational difficulty lies in the
sudden switching on of the atomistic interaction when a coarse-grained
molecule enters the hybrid region. If two molecules are entering at
the same time and the same location, then the atomistic contribution
to the intermolecular interaction~\eqref{eqn:f-f-interpol} or
\eqref{eqn:f-v-interpol} is infinity, which drives the simulation
unstable. This numerical difficulty can be avoided by using capped
atomistic interaction~\cite{praprotnik2005adaptive}, or by using a
gradually switching-on core-softened atomistic
interaction~\cite{heyes2010thermodynamic}.
In Ref.~\cite{wang2013grand}, the authors instead tested with
Weeks-Chandler-Andersen (WCA) potential~\cite{weeks1971role} as the
coarse-grained model, which is a short-ranged and pure repulsive
interaction.  For a SPC/E water system, the cut-off radius of WCA potential
can be 2.4 time smaller than the cut-off used in the atomistic
region. Since the computational cost with is of order $\mo(r_c^3)$,
the computational cost spent on each pair interaction
is 19 times cheaper. For each pair of molecules the atomistic model computes
10 pairwise interactions (9 electrostatic + 1 van der Waals), while the
WCA model computes only one, therefore the WCA model in total costs $1/190$ 
computational effort on force computation than atomistic model.
The WCA approach has been successfully used in calculating the
chemical potential of various complex fluids and mixtures~\cite{agarwal2014chemical}.


% Therefore
% certain manipulation in the hybrid region is need improve the accuracy
% of $p(\vect x_\HY, N_\HY\vert N_\AT)$. However, it is still not clear
% what is the sufficient conditions to achieve good accuracy in $p(\vect x_\HY, N_\HY\vert N_\AT)$.
% It is easy to raise necessary conditions: The marginal distributions
% of the hybrid cooridnates
% \begin{align}
%   p(\vect x_\HY) = \sum_{N_\HY = 0}^\infty \sum_{N_\AT = 0}^\infty p(\vect x_\HY, N_\HY\vert N_\AT) p(N_\AT)
% \end{align}
% should be the same as the reference system. Here we use the fact that
% the probability $ p(N_\AT)$ should be of good accuracy, which will be
% discussed later. This approach is validated because the discussion of
% accuracy of $ p(N_\AT)$ does not require a good accuracy of $ p(\vect
% x_\HY, N_\HY\vert N_\AT)$.  The $m$th marginal distribution of a probability density saying $p(\vect x_\HY)$ is defined
% by
% \begin{align}
%   p_\HY^{(m)}(\vect x_1, \cdots \vect x_m) = \int\cdots\int d\vect x_{m+1}\cdots d\vect x_{N_\HY}
%   p (\vect x_1, \cdots, \vect x_m, \vect x_{m+1}, \cdots \vect x_{N_\HY})
% \end{align}
% In a homogeneous system, the first marginal distribution is the
% density profile in the


% It is not desirable to explicitly write the 
      
% Eq.~\eqref{eqn:dist-1-0} and \eqref{eqn:dist-1-1} are equivalent to 

% In 
% A good accuracy means that the atomistic region is embeded into the AdResS
% To answer what is an accurate equilibrium AdResS simulation,
% To understand the statistical properties of an AdResS system, 


\section{Thermodynamic properties of adaptive resolution simulation}
\label{sec:thermodynamic}

In the reference system, if the equilibrium state is achieved, then
the temperature, pressure and chemical potential of the atomistic and
coarse-grained subregions match. In AdResS system, the global uniform
temperture distrubution in equilibrium is impoosed by the Langevin
thermostat.  However, extra term appear in the pressure or chemical
potential relation when the momentum or energy conservation is absent
(see Tab.~\ref{tab:conv-laws}), respectively.

The chemical potential balance can be investigated from the fact that
when the uniform density distribution is guaranteed by thermodynamic force in equilibrium, the chemical potential
difference between the resolutions is compensited by $\omega_0$, which
is the work per molecule from the filter when a molecule leaves the
coarse-grained region and enters the atomistic region (see
relation~\eqref{eqn:mu-eq}).  Now the question turns out to be what
contributes to the work $\omega_0$.  For the potential interpolation,
the work of the filter is nothing but the work of the thermodynamic
force plus the extra kinetic energy corresponding to the extra DOFs
when a molecule obtains higher resolution:
\begin{align}\label{eqn:mu0-v}
  \omega_0 = \omega^{\thf,V} + \omega^\dof,
\end{align}
where $ \omega^{\thf,V}$ denotes the work of the thermodynamic force
of potential interpolation.
This work is path independent if the thermodynamic force is defined as a function of the distance to the atomistic region, and applies along the gradient of the weighting function.
We always assume the thermodynamic force satisfies these conditions.
For the force interpolation, 
we denote the extra contribution due to the absence of the enregy conservation
by $\omega^\exc$, then
\begin{align}\label{eqn:mu0-f}
  \omega_0 = \omega^{\thf} + \omega^\exc + \omega^\dof,
\end{align}
where $\omega^{\thf}$ is the work of the thermodynamic force of force interpolation.
The magnitude of the extra term $\omega^\exc$ is unclear up to now,
however, it is easy to computewith the help of the pressure relations.

For the force interpolation, the pressure of different resolutions
is related by~\cite{fritsch2012adaptive}
\begin{align}\label{eqn:p-eq-f}
  p_\CG - p_\AT = \rho_0 \:\omega^{\thf},
\end{align}
in which the work of the thermodynamic force again plays an important
role.  For the potential interpolation, the pressure relation can be
investigated by an imaginary infiniesimal volume increment of the atomistic
region, and the same amount of volume decrement of the coarse-grained
region. Following this idea, Ref.~\cite{agarwal2014chemical} proves that in
equilibrium the pressure between the resolutions is related by
\begin{align}\label{eqn:p-eq-v}
  p_\CG - p_\AT = \rho_0 (\omega^{\thf,V} - \omega^\rep)  
\end{align}
where $\omega^\rep$ is the work done by the average force of change representation:
\begin{align}\label{eqn:work-rep}
  \omega^\rep = \int \langle \vect F^\rep(\vect r)\rangle_V\circ d\vect r
\end{align}
where ``$\circ$'' means that the integral should be understood as along the path.
Since the force of changing representation acts always along the gradient of the weighting
function, therefore, if the system is homogeneous in the hybrid region, then the integral
is path independent. The ensemble average  can be estimated by sampling.
The force of changing representation merges from the last term of potential
interpolation~\eqref{eqn:f-v-interpol}, and contributes to the
pressure relation~\eqref{eqn:p-eq-v} because it does not satisfies the Newton's third
law.

Using Eq.~\eqref{eqn:mu0-v} and \eqref{eqn:mu0-f} one has $\omega^{\thf,V} - \omega^\thf = \omega^\exc$,
while using \eqref{eqn:p-eq-f} and \eqref{eqn:p-eq-v} one has $\omega^{\thf,V} - \omega^\thf = \omega^\rep$.
Therefore, we have 
\begin{align}
  \omega^\exc = \omega^\rep
\end{align}
which gives a explicit expression for the extra energy contribution
due to the absence of energy conservation in the force
interpolation. It should be noted that the ensemble averge in the work
of changing representation~\eqref{eqn:work-rep} is defined for the
potential interpolation, however, the estimate of the term
$\omega^\rep$ does not depend on the ensemble, at least up to the
``first order approximation''~\cite{agarwal2014chemical}, because the
hybrid region of the potential and force interpolation have the same
density. In Ref.~\cite{wang2013grand} an even strong conclusion is shown numerically in the SPC/E water system: The
averge force of changing representation estimated from potential
interpolation is pointwisly identical to that estimated from the force
interpolation. The thermodynamic relation discoved in
force and potential interpolation AdResS schemes are summarized
in Tab.~\ref{tab:thermodynamic}.

\begin{table}
  \centering
  \caption{A summary of the thermodynamic relations satisfied in force and potential interpolation AdResS.}
  \label{tab:thermodynamic}
  \begin{tabular*}{0.99\textwidth}{@{\extracolsep{\fill}}lll}\hline\hline
    &         Force interp. AdResS     &       Potential interp. AdResS \\
    Temperature    &   {$T_\AT = T_\CG$}                                                & {$T_\AT = T_\CG$}                                        \\
    Pressure       &   {$p_\CG - p_\AT = \rho_0\, \omega^\thf$}                          & {$p_\CG - p_\AT = \rho_0(\omega^{\thf,V} - \omega^\rep)$} \\
    Chemical pot.  &   {$\mu_\CG - \mu_\AT = (\omega^\thf + \omega^\dof +\omega^\rep)$}   & {$\mu_\CG - \mu_\AT = \omega^{\thf,V}+ \omega^\dof$}      \\\hline\hline
  \end{tabular*}
\end{table}


\section{Dynamical properties: adaptive resolution simulation beyond equilibrium}

\recheck{the difficulty of Langevin thermostat: destroy dynamics. Test local thermostating~\cite{wang2014exploring}
}

\subsection{Velocity auto-correlation of water}


\subsection{Alanine dipeptide dissolved in water: equilibrium and dynamical properties}

\begin{figure}
  \centering
  \includegraphics[width=0.99\textwidth]{figs/system.alanine/all.eps}
  \caption{(a): A schematic plot of the alanine dipeptide molecule,
    and the two dihedral angles $\phi$ and $\psi$ that are used to
    represent the conformations of the molecule. (b) and (c): The free
    energy landscape plotted using variables $\phi$ and $\psi$.  (b)
    is for full atomistic reference simulation, while (c) is for
    AdResS simulation.}
  \label{fig:ala}
\end{figure}

The alanine dipeptide molecule (see Fig.~\ref{fig:ala}~(a)) is usually
used as a testing case for computational method in simulating real
biomolecular system.
The system presents a very clear time-scale seperation: There are fast
motions like bond and angle vibration that happens on the time-scale of tens of femtoseconds, while
there are slow conformational changes that happens on the time-scale of hundreds of picoseconds.
The dihedral angles $\phi$ and $\psi$ (see
Fig.~\ref{fig:ala}~(a)) are usually chosen as slow variables that  describles
the molecular conformation and its transitions of the moelcules, which are of
general biological interest.

The free energy defined as the logrithm of equilibrium probability density over
$\phi$--$\psi$ space:
\begin{align}
  F(\phi,\psi) = -k_BT \ln p_\equi(\phi,\psi)
\end{align}
is plotted in Fig.~\ref{fig:ala}~(b) and (c). The AdResS free energy is
in good consistency with the full atomistic reference system. This is expected
at least in equilibrium, because as discussed in Sec.~\ref{sec:statistical}, the
AdResS sampling approximates the atomistic grand-canonical ensemble.

In pratice, not only the equilibrium probability density if of interest,
sometimes how the system relax to equilibrium is also of interest.
A direct analysis of the MD trajectories for these properties is not easy.
% Or equivalently
% at which timescale the slow dynamics  happens and from which conformation to which it corresponds to.
One possible solution is the Markov state model (MSM), which
approximate the original high-dimensional dynamics by a finite-state
Markov process (also called reduced dynamics),
and the original time-dependent probability density define on the phase
space $p_t(\vect x)$ is approximated by a  temporal discrete $\vect p_{k\tau}$ probability defined on the finite-state space.
The step of the temporal discretization $\tau$ is called the lag-time.
We always assume the reduced
dynamics is Markovian, although uaually it is not so in practice, and may become one of the main sources of the error.
It would be lengthy to discuss the topic here, and the interested readers are refereed to Ref.~\cite{}.
Due to the Markovianity of the reduced dynamics, the
probability at time $k\tau$ is given by
\begin{align}
\vect p_{k\tau} = \mathcal Q^k(\tau)\circ \vect p_0,
\end{align}
where $\mathcal Q(\tau)$ is the transfer operator
associated to the reduced dynamics. In equilibrium, the transfer operator is time-homogeneous.
Due to the Markovianity, for any $k$, we have
$p_{t+k\tau}(\vect x) = \mathcal Q^k(\tau)\circ p_t (\vect x)$.
If the propagator is irreducible and aperiodic, than according to Perron-Frobenius theorem, the maximum
eigenvalue is single and equal to 1.
If the dynamics
is further assumed to be reversible, then all eigenvalues of the propagator are
real valued.
The first $m$ largest eigenvalues are denoted by $1 = \lambda_1 > \lambda_2 \geq \lambda_3 \geq \cdots \geq \lambda_m$, and
the corresponding eigenvetors are denoted by $\Phi_1, \Phi_2, \cdots, \Phi_m$. The leading eigenvector is nothing but the
equilibrium probability that satisfies $\Phi_1 = \mathcal Q(\tau)\circ \Phi_1$.
The time evolution of the reduced probability density can be expaned by 
\begin{align}\label{eqn:expan}
  \vect p_{k\tau} = \Phi_1 + \sum_{i=2}^m e^{-\frac{k\tau}{t_i}} \,a_i\Phi_i + \textrm{fast decaying dynamics},
\end{align}
where $t_i$ is the timescale that corresponds to the $i$th eigenvalue:
\begin{align}\label{eqn:time-scale}
  t_i  = -\frac{\tau}{\log\lambda_i}, \quad i=2, \cdots, m,
\end{align}
and $a_i$ are constant that are determined by the initial state. As can be seen from Eq.~\eqref{eqn:expan}, the
time-dependent probability  converges to the equilibrium probability as time goes to infinity.
The timescale of the slow part of the relaxation is govenerned by the leanding eigenvectors through Eq.~\eqref{eqn:time-scale},
while the conformational change corresponds to each timescale is indicated by the eigenvector.
We assume a gap in the spectrum between $\lambda_m$ and the rest of the spectrum $\lambda_{m+1}, \cdots$,
therefore, the dynamics of the rest of the spectrum decays out very fast, and is not of particular interest.

The accuracy analysis of the MSM can be find in literature e.g.~\cite{}.

% The spectral anaysis of the MSM will reveal the
% implied timescales, and corresponding conformational changes.
% It has
% been proved that MSM is a good approximation to the original dynamics.

\begin{figure}
  \centering
  \includegraphics[width=0.4\textwidth]{figs/system.alanine/fig-eig-val.png}
  \caption{The non-trivial leading timescale calculated from the
    Markov state modeling for the system of alanine dipeptide
    dissolved in water. In this figure, $t_2$ $t_3$ and $t_4$
    correspond to the first, second and third non-trivial leading
    timescale, respectively. The horizontal axis $\tau$ is the
    lag-time used to build the Markov state model. For a sufficient
    large $\tau$ the values of the timescales should be independent on
    the lag-time. The shadowing regions around the lines indicate the
    statistical uncertainty of the result. }
  \label{fig:ala-msm-t}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=0.3\textwidth]{figs/system.alanine/fig-eig-vec-atom-2.eps}
  \includegraphics[width=0.3\textwidth]{figs/system.alanine/fig-eig-vec-atom-3.eps}
  \includegraphics[width=0.3\textwidth]{figs/system.alanine/fig-eig-vec-atom-4.eps}\\
  \includegraphics[width=0.3\textwidth]{figs/system.alanine/fig-eig-vec-adress-2.eps}
  \includegraphics[width=0.3\textwidth]{figs/system.alanine/fig-eig-vec-adress-3.eps}
  \includegraphics[width=0.3\textwidth]{figs/system.alanine/fig-eig-vec-adress-4.eps}\\
  \caption{The eigenvectors corresponding to the first three leading timescales.
    The first row presents the eigenvectors of the full atomistic reference, while the second
    row presents those of the AdResS simulation. From left to right $\Phi_2$, $\Phi_3$ and $\Phi_4$ that correspond to
    timescales $t_2$, $t_3$ and $t_4$ are given (see also Fig.~\ref{fig:ala-msm-t}). The magnitude of the eigenvectors are
    denoted by the color. 
    The conformational
    changes indicated by the eigenvectors are noted on the plots.}
  \label{fig:ala-msm-v}
\end{figure}

Here we present the eigenvalues and eigenvectors in
Fig.~\ref{fig:ala-msm-t} and \ref{fig:ala-msm-v}, respectively. The
eigenvalue should be $\tau$ independent if the MSM is of good
accuracy. From the Fig.~\ref{fig:ala-msm-t}, the full atomistic
reference and the AdResS result are consistent within the statistical
uncertainty.  The eigenvectors of the AdResS are also consistent with
those of the full atomistic reference. Although calculated from the
equilibrium MD simulations, the leading timescales and the
corresponding eigenvectors are not the equilibrium properties, because
the transition probability (or the propagator) are actually
time-correlation functions, which are called dynamical properties in
this context. A good reproduction of the equilibrium properties does
not necessary implies a reproduction of the dynamical properties.
Although currently there is still no theoretical answer why AdResS is
so good in reproducing the dynamical properties, the provided
numercial example suggests that AdResS is promising in the applications
beyond equilibrium.








\bibliography{ref}{}
\bibliographystyle{unsrt}

% \begin{thebibliography}{}
% % and use \bibitem to create references.
% \bibitem{RefJ}
% % Format for Journal Reference
% Author, Journal \textbf{Volume}, (year) page numbers
% % Format for books
% \bibitem{RefB}
% Author, \textit{Book title} (Publisher, place year) page numbers
% % etc
% \end{thebibliography}

\end{document}

% end of file template.tex

